package pif

import (
	"n64emu/pkg/core/joybus"
	"n64emu/pkg/types"
	"testing"

	"github.com/stretchr/testify/assert"
)

// definition of dummy device
type MockJoyBusDevice struct {
	wantCmd   joybus.CommandType
	wantTxLen types.Byte
	wantRxLen types.Byte
	readDatas []types.Byte
}

func (m *MockJoyBusDevice) Run(cmd joybus.CommandType, txBuf, rxBuf []types.Byte) joybus.CommandResult {
	if cmd != m.wantCmd {
		return joybus.DeviceNotPresent
	}
	if len(txBuf) != int(m.wantTxLen) {
		return joybus.UnableToTransferDatas
	}
	if len(rxBuf) != int(m.wantRxLen) {
		return joybus.UnableToTransferDatas
	}
	// copy datas
	for i := 0; (i < len(rxBuf)) && (i < len(m.readDatas)); i++ {
		rxBuf[i] = m.readDatas[i]
	}
	return joybus.Success
}

func TestUpdate(t *testing.T) {
	const numOfControllers = 4
	const numOfEEPROMs = 2
	tests := []struct {
		name        string
		controllers [numOfControllers]*MockJoyBusDevice
		eeproms     [numOfEEPROMs]*MockJoyBusDevice
		initialRAM  [PIFRAMSize]types.Byte
		wantRAM     [PIFRAMSize]types.Byte
	}{
		{
			name:        "DeviceNotPresent",
			controllers: [numOfControllers]*MockJoyBusDevice{nil, nil, nil, nil},
			eeproms:     [numOfEEPROMs]*MockJoyBusDevice{nil, nil},
			initialRAM: [PIFRAMSize]types.Byte{
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller0: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller1: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller2: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller3: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [end of setup],                            [dummy*7]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, //              [dummy*7],                             [new command]
			},
			wantRAM: [PIFRAMSize]types.Byte{
				0xff, 0x01, 0x84, 0x01, 0xff, 0xff, 0xff, 0xff, // controller0: [dummy, tx:1, rx:(device not present, 4), cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x84, 0x01, 0xff, 0xff, 0xff, 0xff, // controller1: [dummy, tx:1, rx:(device not present, 4), cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x84, 0x01, 0xff, 0xff, 0xff, 0xff, // controller2: [dummy, tx:1, rx:(device not present, 4), cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x84, 0x01, 0xff, 0xff, 0xff, 0xff, // controller3: [dummy, tx:1, rx:(device not present, 4), cmd:ReadButtonValues], [dummy*4]
				0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [end of setup],                                                  [dummy*7]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*7],                                                          [idle]
			},
		},
		{
			name: "ReadButtonValuesFromPort2",
			controllers: [numOfControllers]*MockJoyBusDevice{
				nil,
				nil,
				{wantCmd: joybus.ReadButtonValues, wantTxLen: 1, wantRxLen: 4, readDatas: []types.Byte{0xaa, 0x99, 0x55, 0x66}},
				nil,
			},
			eeproms: [numOfEEPROMs]*MockJoyBusDevice{nil, nil},
			initialRAM: [PIFRAMSize]types.Byte{
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller0: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller1: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller2: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller3: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [end of setup],                            [dummy*7]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, //              [dummy*7],                              [new command]
			},
			wantRAM: [PIFRAMSize]types.Byte{
				0xff, 0x01, 0x84, 0x01, 0xff, 0xff, 0xff, 0xff, // controller0: [dummy, tx:1, rx:(device not present, 4), cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x84, 0x01, 0xff, 0xff, 0xff, 0xff, // controller1: [dummy, tx:1, rx:(device not present, 4), cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xaa, 0x99, 0x55, 0x66, // controller2: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [rd0, rd1, rd2, rd3]
				0xff, 0x01, 0x84, 0x01, 0xff, 0xff, 0xff, 0xff, // controller3: [dummy, tx:1, rx:(device not present, 4), cmd:ReadButtonValues], [dummy*4]
				0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [end of setup],                                                  [dummy*7]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*7],                                                          [idle]
			},
		},
		{
			name: "ContinueIdle",
			controllers: [numOfControllers]*MockJoyBusDevice{
				nil,
				nil,
				{wantCmd: joybus.ReadButtonValues, wantTxLen: 1, wantRxLen: 4, readDatas: []types.Byte{0xaa, 0x99, 0x55, 0x66}},
				nil,
			},
			eeproms: [numOfEEPROMs]*MockJoyBusDevice{nil, nil},
			initialRAM: [PIFRAMSize]types.Byte{
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller0: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller1: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller2: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller3: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [end of setup],                            [dummy*7]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*7],                                    [idle]
			},
			wantRAM: [PIFRAMSize]types.Byte{
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller0: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller1: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller2: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller3: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [end of setup],                            [dummy*7]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*7],                                    [idle]
			},
		},
		{
			name: "ReadButtonValuesFromAllPort",
			controllers: [numOfControllers]*MockJoyBusDevice{
				{wantCmd: joybus.ReadButtonValues, wantTxLen: 1, wantRxLen: 4, readDatas: []types.Byte{0x00, 0x11, 0x22, 0x33}},
				{wantCmd: joybus.ReadButtonValues, wantTxLen: 1, wantRxLen: 4, readDatas: []types.Byte{0x44, 0x55, 0x66, 0x77}},
				{wantCmd: joybus.ReadButtonValues, wantTxLen: 1, wantRxLen: 4, readDatas: []types.Byte{0x88, 0x99, 0xaa, 0xbb}},
				{wantCmd: joybus.ReadButtonValues, wantTxLen: 1, wantRxLen: 4, readDatas: []types.Byte{0xcc, 0xdd, 0xee, 0xff}},
			},
			eeproms: [numOfEEPROMs]*MockJoyBusDevice{nil, nil},
			initialRAM: [PIFRAMSize]types.Byte{
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller0: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller1: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller2: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xff, 0x01, 0x04, 0x01, 0xff, 0xff, 0xff, 0xff, // controller3: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [dummy*4]
				0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [end of setup],                            [dummy*7]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, //              [dummy*7],                              [new command]
			},
			wantRAM: [PIFRAMSize]types.Byte{
				0xff, 0x01, 0x04, 0x01, 0x00, 0x11, 0x22, 0x33, // controller0: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [rd0, rd1, rd2, rd3]
				0xff, 0x01, 0x04, 0x01, 0x44, 0x55, 0x66, 0x77, // controller1: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [rd0, rd1, rd2, rd3]
				0xff, 0x01, 0x04, 0x01, 0x88, 0x99, 0xaa, 0xbb, // controller2: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [rd0, rd1, rd2, rd3]
				0xff, 0x01, 0x04, 0x01, 0xcc, 0xdd, 0xee, 0xff, // controller3: [dummy, tx:1, rx:4, cmd:ReadButtonValues], [rd0, rd1, rd2, rd3]
				0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [end of setup],                                       [dummy*7]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //              [dummy*7],                                               [idle]
			},
		},
		{
			name:        "RequestInfoFromEEPROM0",
			controllers: [numOfControllers]*MockJoyBusDevice{nil, nil, nil, nil},
			eeproms: [numOfEEPROMs]*MockJoyBusDevice{
				{wantCmd: joybus.RequestInfo, wantTxLen: 1, wantRxLen: 3, readDatas: []types.Byte{0x01, 0x23, 0x45}},
				nil,
			},
			initialRAM: [PIFRAMSize]types.Byte{
				0x00, 0x00, 0x00, 0x00, 0xff, 0x01, 0x03, 0x00, // [skip*4],        [dummy, tx:1, rx:3, cmd:RequestInfo]
				0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, // [dummy*3, skip], [end of setup],            [dummy*3]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, // [dummy*7],                              [new command]
			},
			wantRAM: [PIFRAMSize]types.Byte{
				0x00, 0x00, 0x00, 0x00, 0xff, 0x01, 0x03, 0x00, // [skip*4],        [dummy, tx:1, rx:3, cmd:RequestInfo]
				0x01, 0x23, 0x45, 0xff, 0xfe, 0x00, 0x00, 0x00, // [dummy*3, skip], [end of setup],            [dummy*3]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*8]
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // [dummy*7],                                      [idle]
			},
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Setup structure
			p := PIF{}
			p.ram = tt.initialRAM
			for i := 0; i < numOfControllers; i++ {
				if tt.controllers[i] != nil {
					var c joybus.JoyBus = tt.controllers[i]
					p.controllers[i] = &c
				}
			}
			for i := 0; i < numOfEEPROMs; i++ {
				if tt.eeproms[i] != nil {
					var c joybus.JoyBus = tt.eeproms[i]
					p.eeproms[i] = &c
				}
			}
			// Run
			p.Update()
			// Verify
			assert.Equal(t, tt.wantRAM, p.ram)
		})
	}
}
